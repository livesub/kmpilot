$(function() {
	var menu_ok; //선택된 메뉴의 인텍스 변수
	//클릭이벤트
	$('.user_group li').click(function() {
		var choice = $(this).index();
		$('.user_group li').each(function(idx) {
			if(idx == choice) {
				$(this).removeClass('').addClass('on');
				menu_ok = choice;
			} else {
				$(this).removeClass('on').addClass('');

			}
		});
	});
	//전체선택 체크박스 클릭
	$("#check_all_addr").click(function(){
		//만약 전체 선택 체크박스가 체크된상태일경우
		if($("#check_all_addr").prop("checked")) {
			//해당화면에 전체 checkbox들을 체크해준다
			$("input[name=m_idx]").prop("checked",true);

		// 전체선택 체크박스가 해제된 경우
		} else {
			//해당화면에 모든 checkbox들의 체크를해제시킨다.
			$("input[name=m_idx]").prop("checked",false);
		}
	})
});

function getTypeList(a,b){
	switch(b){
		case "group":	//그룹검색
			$("#addr_group_type").val("G");
			break;
		case "branch":	//지회검색
			$("#addr_group_type").val("B");
			break;
		case "edu":	//교육검색
			$("#addr_group_type").val("E");
			break;
		default:break;
	}
	$(".user_group li" ).click(function(){
		index = $(this).index();
		tg_text = $(".user_group > li:eq("+index+") > a").html();
		$("#listHeadLine").html(tg_text);
	});
	$('#addr_sw').val('');
	$('#addr_group').val(a);
	$("#addr_search").submit();
}

function setAddrBind(ret_data){
	var ret	= jQuery.parseJSON(ret_data);
	var dwrResult = ret.list;
 	$("#listUL").html("");
	if(dwrResult.length){
		for(var i=0; i< dwrResult.length; i++){
			var objTR 	= document.createElement("li");
			$(objTR).each(function() {
				$(this).attr("id",dwrResult[i].fidx);
			});
			if(dwrResult[i].mb_hp){
				var chk_mobile_status = "";
				var chk_mobile = "&lt;"+dwrResult[i].mb_hp+"&gt;";

			}else{
				var chk_mobile_status = " disabled ";
				var chk_mobile = "";
			}
			var tr_data1 = "";
			tr_data1 = "<input type='checkbox' name='m_idx'"+chk_mobile_status+"class='checkbox-m_idx' id='m_idx_"+dwrResult[i].mb_no+"' value='"+dwrResult[i].mb_no+"|"+dwrResult[i].mb_id+"|"+dwrResult[i].mb_name+"|"+dwrResult[i].mb_hp+"'/> <label for='m_idx"+dwrResult[i].mb_no+"'>"+dwrResult[i].mb_name+" "+chk_mobile+"</label>";
			$(objTR).html(tr_data1);
			$("#listUL").append(objTR);
		}
		$(".checkbox-mb_no").change(function() {
		if($(this).is(':checked'))
			$(this).parent().addClass('selected');
		else
			$(this).parent().removeClass('selected');
		});
	}else{
		alert("데이터가 없습니다.");
	}
}
function multi_add_target() {
	var checkedCount = 0;
	$("input[name=m_idx]").each(
		function(index) {
			if($(this).attr("checked")){
				var str = $(this).val();
				var arrString = str.split("|");

				if($("input[id=s_idx_"+arrString[0]+"]").length){
					alert(arrString[2]+" 은(는) 이미 추가 되어 있습니다.  ");
					$(this).parent().removeClass('selected');
					$(this).attr('checked',false);
				}else{
					var objTR 	= document.createElement("li");
					var li_data = "";
					li_data = "<input type='checkbox' name='s_idx' class='checkbox-s_idx' id='s_idx_"+arrString[0]+"' value='"+arrString[2]+"|"+arrString[1]+"|"+arrString[3]+"'/> <label for='s_idx_"+arrString[0]+"'>"+arrString[2]+"&lt;"+arrString[3]+"&gt;</label>";
					$(objTR).html(li_data);
					$("#toUL").append(objTR);
					$(this).parent().removeClass('selected');
					$(this).attr('checked',false);
					checkedCount++
				}
			}
		}
	);
	$(".checkbox-mb_no").change(function() {
	if($(this).is(':checked'))
		$(this).parent().addClass('selected');
	else
		$(this).parent().removeClass('selected');
	});
	var v1=parseInt($("#send_cnt").html());
	var v2=parseInt(checkedCount);
	if($("#send_cnt").html()){
		total = eval(v1+v2);
		$("#send_cnt").html(total);
	}else{
		$("#send_cnt").html(checkedCount);
	}
}
function multi_remove_target() {
	var checkedRemoveCount = 0;
   $("#toUL input[type=checkbox]:checked").filter(function() {
		checkedRemoveCount++
		$(this).parent().remove();
	});
	var v3=parseInt($("#send_cnt").html());
	var v4=parseInt(checkedRemoveCount);
	if($("#send_cnt").html()){
		total = eval(v3-v4);
		$("#send_cnt").html(total);
	}else{
		$("#send_cnt").html(v3);
	}
}
$(document).ready(function(){
	var req_data = jQuery.param({"mode": "mb_addr","prcCode": "ajax"});
	request_json("sms_action.php", req_data, "setAddrBind");
	$("#addr_search").submit(function(e){
		var postData = $(this).serializeArray();
		console.log(postData);
		var formURL = "sms_action.php";
		$.ajax({
			url : formURL,
			type: "POST",
			data : postData,
			success:function(data, textStatus, jqXHR){
				var bind_results = $.parseJSON(data);
				if(bind_results.count > 0){
					setAddrBind(data);
				}else{
					alert("검색결과가 없습니다.");
					$("#listUL").empty();
				}
			},
			error: function(jqXHR, textStatus, errorThrown){
				$("#simple-msg").html('<pre><code class="prettyprint">AJAX Request Failed<br/> textStatus='+textStatus+', errorThrown='+errorThrown+'</code></pre>');
			}
		});
		e.preventDefault();	//STOP default action
	});
	$("#addr_search_btn").click(function(){
		if($("#addr_sw").val()==""){
			alert('검색어를 입력하세요');
			return false;
		}
		$("#addr_search").submit();
	});
	$("#group_list").click(function(){
		//$("#loading_glist").html("<img src='/_img/common/loading2.gif' />");
		//$("#loading_glist").css("display","block");
		$.ajax({
			url : "sms_action.php",
			type: "POST",
			data : {"s_word" : escape($("#input_number").val()),"mode":"group_addr","prcCode":"ajax" },
			success:function(data, textStatus, jqXHR){
				var bind_results = $.parseJSON(data);
				$(".user_group").find("li").remove().end();
				if(bind_results.count > 0){
					var ret	= jQuery.parseJSON(data);
					var dwrResult = ret.list;
					if(dwrResult.length){
						$(".user_group").append("<li class=\"on first\" id=\"group_all\"><a href=\"javascript:;\" onclick=\"getTypeList();\">그룹전체<em class=\"cnt\"></em></a></li>");
						for(var i=0; i< dwrResult.length; i++){
							//$(".user_group").append("<li><a onclick=\"getTypeList('"+dwrResult[i].m_gkey+"','group');\" href=\"javascript:;\">"+dwrResult[i].m_gname+"</a><em class=\"cnt\"> ("+dwrResult[i].m_gcount+")</em></li>");
							$("#title_ment").html("그룹 전체선택");
							$(".user_group").append("<li><a onclick=\"getTypeList('"+dwrResult[i].gr_id+"','group');\" href=\"javascript:;\">"+dwrResult[i].gr_subject+"</a><em class=\"cnt\"> ("+dwrResult[i].m_gcount+")</em></li>");
						}
					}
				}else{
					$(".user_group").append("<tr><td><span>검색된 그룹리스트가 없습니다.</span></td></tr>");
				}
			},
			error: function(jqXHR, textStatus, errorThrown){
				$("#simple-msg").html('<pre><code class="prettyprint">AJAX Request Failed<br/> textStatus='+textStatus+', errorThrown='+errorThrown+'</code></pre>');
			}
		});
	});
	$("#branch_list").click(function(){
		//$("#loading_glist").html("<img src='/_img/common/loading2.gif' />");
		//$("#loading_glist").css("display","block");
		$.ajax({
			url : "sms_action.php",
			type: "POST",
			data : {"s_word" : escape($("#input_number").val()),"mode":"branch_addr","prcCode":"ajax" },
			success:function(data, textStatus, jqXHR){
				var bind_results = $.parseJSON(data);
				$(".user_group").find("li").remove().end();
				if(bind_results.count > 0){
					var ret	= jQuery.parseJSON(data);
					var dwrResult = ret.list;
					if(dwrResult.length){
						$("#title_ment").html("지회 전체선택");
						$(".user_group").append("<li class=\"on first\" id=\"group_all\"><a href=\"javascript:;\" onclick=\"getTypeList();\">지회전체<em class=\"cnt\"></em></a></li>");
						for(var i=0; i< dwrResult.length; i++){
							$(".user_group").append("<li><a onclick=\"getTypeList('"+dwrResult[i].br_key+"','branch');\" href=\"javascript:;\">"+dwrResult[i].br_name+"</a><em class=\"cnt\"> ("+dwrResult[i].br_count+")</em></li>");
						}
					}
				}else{
					$(".user_group").append("<tr><td><span>검색된 지회리스트가 없습니다.</span></td></tr>");
				}
			},
			error: function(jqXHR, textStatus, errorThrown){
				$("#simple-msg").html('<pre><code class="prettyprint">AJAX Request Failed<br/> textStatus='+textStatus+', errorThrown='+errorThrown+'</code></pre>');
			}
		});
	});


	//교육 관련
	$("#edu_list").click(function(){
		$.ajax({
			url : "sms_action.php",
			type: "POST",
			data : {"s_word" : escape($("#input_number").val()),"mode":"edu_addr","prcCode":"ajax","now_year":$("#now_year").val() },
			success:function(data, textStatus, jqXHR){
				var bind_results = $.parseJSON(data);
				$(".user_group").find("li").remove().end();
				if(bind_results.count > 0){
					var ret	= jQuery.parseJSON(data);
					var dwrResult = ret.list;
					if(dwrResult.length){
						$("#title_ment").html("교육 전체선택");
						$(".user_group").append("<li class=\"on first\" id=\"group_all\"><a href=\"javascript:;\" onclick=\"getTypeList();\">교육전체<em class=\"cnt\"></em></a></li>");
						for(var i=0; i< dwrResult.length; i++){
							$(".user_group").append("<li><a onclick=\"getTypeList('"+dwrResult[i].edu_idx+"','edu');\" href=\"javascript:;\">"+dwrResult[i].edu_name_kr+"</a><em class=\"cnt\"> ("+dwrResult[i].apply_cnt+")</em></li>");
						}
					}
				}else{
					$(".user_group").append("<tr><td><span>검색된 교육리스트가 없습니다.</span></td></tr>");
				}
			},
			error: function(jqXHR, textStatus, errorThrown){
				$("#simple-msg").html('<pre><code class="prettyprint">AJAX Request Failed<br/> textStatus='+textStatus+', errorThrown='+errorThrown+'</code></pre>');
			}
		});
	});


	$("#recent_list").click(function(){

		//$("#loading_glist").html("<img src='/_img/common/loading2.gif' />");
		//$("#loading_glist").css("display","block");
		$.ajax({
			url : "etc.sms_action.php",
			type: "POST",
			data : {"s_word" : escape($("#input_number").val()),"mode":"recent_addr","prcCode":"ajax" },
			success:function(data, textStatus, jqXHR){
				var bind_results = $.parseJSON(data);
				$("#listUL").find("li").remove().end();
				if(bind_results.count > 0){
					var ret	= jQuery.parseJSON(data);
					var dwrResult = ret.list;
					if(dwrResult.length){
						for(var i=0; i< dwrResult.length; i++){
							if(dwrResult[i].m_rchk == "1"){
								var chk_guest_status = " ";
							}else{
								var chk_guest_status = " disabled";
							}
							$("#listUL").append("<li><input type='checkbox'"+chk_guest_status+" name='m_idx' class='checkbox-m_idx' id='m_idx_"+dwrResult[i].m_ridx+"' value='"+dwrResult[i].m_ridx+"|"+dwrResult[i].m_rid+"|"+dwrResult[i].m_rname+"|"+dwrResult[i].m_rphone+"'/> <label for='m_idx_"+dwrResult[i].m_ridx+"'>"+dwrResult[i].m_rname+" &lt;"+dwrResult[i].m_rphone+"&gt;</label></li>");
						}
					}
				}else{
					$(".#listUL").append("<li><span>검색된 그룹리스트가 없습니다.</span></li>");
				}
			},
			error: function(jqXHR, textStatus, errorThrown){
				$("#simple-msg").html('<pre><code class="prettyprint">AJAX Request Failed<br/> textStatus='+textStatus+', errorThrown='+errorThrown+'</code></pre>');
			}
		});
	});

	$("#important_list").click(function(){

		//$("#loading_glist").html("<img src='/_img/common/loading2.gif' />");
		//$("#loading_glist").css("display","block");
		$.ajax({
			url : "etc.sms_action.php",
			type: "POST",
			data : {"s_word" : escape($("#input_number").val()),"mode":"important_addr","prcCode":"ajax" },
			success:function(data, textStatus, jqXHR){
				var bind_results = $.parseJSON(data);
				$("#listUL").find("li").remove().end();
				if(bind_results.count > 0){
					var ret	= jQuery.parseJSON(data);
					var dwrResult = ret.list;
					if(dwrResult.length){
						for(var i=0; i< dwrResult.length; i++){
							if(dwrResult[i].impt_m_chk == "1"){
								var chk_guest_status = " ";
							}else{
								var chk_guest_status = " disabled";
							}
							$("#listUL").append("<li><input type='checkbox'"+chk_guest_status+" name='m_idx' class='checkbox-m_idx' id='m_idx_"+dwrResult[i].impt_idx+"' value='"+dwrResult[i].impt_idx+"|"+dwrResult[i].impt_id+"|"+dwrResult[i].impt_name+"|"+dwrResult[i].impt_phone+"'/> <label for='m_idx_"+dwrResult[i].impt_idx+"'>"+dwrResult[i].impt_name+" &lt;"+dwrResult[i].impt_phone+"&gt;</label></li>");
						}
					}
				}else{
					$(".#listUL").append("<li><span>검색된 그룹리스트가 없습니다.</span></li>");
				}
			},
			error: function(jqXHR, textStatus, errorThrown){
				$("#simple-msg").html('<pre><code class="prettyprint">AJAX Request Failed<br/> textStatus='+textStatus+', errorThrown='+errorThrown+'</code></pre>');
			}
		});
	});
});

function add_number(){
	var selectedArray = [];
	$("input[name='s_idx']").each(function () {
		var retData = $(this).val().split("|");
		var sendnum = retData[2];
		var overlap = false;
		for (var i=0; i< $("#callList li",opener.document).size(); i++){
			var dupchk =($("#callList li:eq("+i+") > input[type='hidden']",opener.document).val());
			var splitchk = dupchk.split("|");
			if (splitchk[2] == sendnum){
				overlap = true;
			}
		}
		if (!overlap){
			$("#callList",opener.document).append("<li data-cnt='1'><input type='hidden' name='phone_num[]' value='"+retData[0]+"|"+retData[1]+"|"+retData[2]+"'>"+retData[0]+"|"+retData[2]+"</li>");
			$("#addphone_cnt",opener.document).text(parseInt($("#addphone_cnt",opener.document).text()) + 1);
		}
    });
	self.window.close();
}